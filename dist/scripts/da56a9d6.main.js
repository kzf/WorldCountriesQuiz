"use strict";var WorldGeo=function(a,b){this.globe={type:"Sphere"},this.land=topojson.feature(a,a.objects.land),this.countries=this.parseCountries(a,b),this.n=this.countries.length,this.borders=topojson.mesh(a,a.objects.countries,function(a,b){return a!==b}),this.projection=d3.geo.orthographic().clipAngle(90)};WorldGeo.prototype.parseCountries=function(a,b){var c=topojson.feature(a,a.objects.countries).features,d=[];return c.forEach(function(a){var c;for(c=0;c<b.length;c++)if(parseInt(b[c].id)===a.id){a.name=b[c].name,d.push(a);break}}),d},WorldGeo.prototype.loadViews=function(a){var b=this.projection;this.canvases=a,this.canvases.forEach(function(a){a.path=d3.geo.path().projection(b).context(a.ctx),a.width=a.ctx.canvas.width,a.height=a.ctx.canvas.height})},WorldGeo.prototype.showCountry=function(a){var b=function(a,b,c,d,e){a.ctx.strokeStyle=e,a.ctx.fillStyle=d,a.ctx.lineWidth=c,a.ctx.beginPath(),a.path(b),d&&a.ctx.fill(),e&&a.ctx.stroke()},c=this;this.canvases.forEach(function(d){var e=d3.geo.centroid(a);if(c.projection.scale(d.height/2-5).rotate([-e[0],-e[1]]).translate([d.width/2,d.height/2]),d.zoom){var f=d.path.bounds(a),g=Math.abs(f[1][0]-f[0][0])/d.width,h=Math.abs(f[1][1]-f[0][1])/d.height;c.projection.scale(Math.min(1e3,100/Math.max(g,h)))}d.ctx.clearRect(0,0,d.width,d.height),b(d,c.globe,1,d.zoom?"#C5EFF7":"#E4F1FE","#89C4F4"),b(d,c.land,.5,"#C8F7C5","#90C695"),b(d,a,0,"#2ECC71",!1),b(d,c.borders,.5,!1,"#90C695")})};var App=function(a,b){this.geo=new WorldGeo(a,b),this.correctAnswerEl=$(".correct-answer").hide(),this.incorrectAnswerEl=$(".incorrect-answer").hide(),this.correctCountryEl=$(".correct-country"),this.countryInputEl=$("#country_input"),this.submitCountryEl=$("#submit_country"),this.countryInputsEl=$("#country_inputs"),this.nextQuestionEl=$("#next_question").hide(),this.nextQuestionButtonEl=$("#next_question_button"),this.currentQuestionEl=$(".current-question"),this.totalQuestionsEl=$(".total-questions"),this.progressIndicatorEl=$(".progress-indicator"),this.quizPage=$("#quiz_page"),this.statsPage=$("#stats_page"),this.menuPage=$("#menu_page"),this.homeButton=$(".home-button"),this.randomQuizButton=$("#random_quiz"),this.viewStatsButton=$("#view_stats"),this.swotUpButton=$("#swot_up"),this.statsList=$("#stats_list"),this.suggestionsContainer=$("#suggestions_container"),this.init()};App.prototype.init=function(){var a=$("body"),b=$(".worldmap-inset"),c=$(".worldmap"),d=d3.select(".worldmap").append("canvas").attr("width",a.innerWidth()).attr("height",c.innerHeight()),e=d3.select(".worldmap-inset").append("canvas").attr("width",b.innerWidth()).attr("height",b.innerHeight());this.geo.loadViews([{ctx:d.node().getContext("2d"),zoom:!0},{ctx:e.node().getContext("2d")}]),this.totalQuizzes=localStorage.totalQuizzes?parseInt(localStorage.totalQuizzes):0;var f=this,g=[];this.geo.countries.forEach(function(a){g.push({value:a.name,data:a.name})}),this.countryInputEl.autocomplete({lookup:g,lookupLimit:4,orientation:"top",width:"320px",onSelect:function(a){f.countryInputEl.text(a.data)}}),this.submitCountryEl.on("click",function(){f.checkAnswer()}),this.nextQuestionButtonEl.on("click",function(){f.showNextQuizQuestion()}),this.randomQuizButton.on("click",function(){f.startQuiz(f.randomQuestions(20))}),this.viewStatsButton.on("click",function(){f.showStats()}),this.homeButton.on("click",function(){f.questions&&(f.saveQuizResults(),f.questions=null),f.showMainMenu()}),this.swotUpButton.on("click",function(){f.startQuiz(f.swotUpQuestions(20))}),this.showMainMenu()},App.prototype.swotUpQuestions=function(a){var b,c=d3.shuffle(this.geo.countries);b=localStorage.stats?JSON.parse(localStorage.stats):{};var d=function(a,c){var d=b[a.name]?b[a.name].lastCorrect:-2,e=b[c.name]?b[c.name].lastCorrect:-2;return d-e};return c.sort(d),c.slice(0,a)},App.prototype.saveQuizResults=function(){if(!$.isEmptyObject(this.results)){var a;a=localStorage.stats?JSON.parse(localStorage.stats):{};for(var b in this.results)this.results.hasOwnProperty(b)&&(a[b]||(a[b]={correct:0,total:0,lastCorrect:-1}),this.results[b]&&(a[b].correct++,a[b].lastCorrect=this.totalQuizzes),a[b].total++);this.totalQuizzes++,localStorage.totalQuizzes=JSON.stringify(this.totalQuizzes),localStorage.stats=JSON.stringify(a)}},App.prototype.showMainMenu=function(){localStorage.stats?this.viewStatsButton.prop("disabled",!1):this.viewStatsButton.prop("disabled",!0),this.quizPage.addClass("hidden-page"),this.statsPage.addClass("hidden-page"),this.menuPage.removeClass("hidden-page")},App.prototype.showStats=function(){var a=JSON.parse(localStorage.stats);this.statsList.empty();var b=function(a){return"linear-gradient(to right, #78d376 "+a+"%, #f16a28 "+a+"%)"},c=[];for(var d in a)a.hasOwnProperty(d)&&(a[d].name=d,c.push(a[d]));c.sort(function(a,b){return b.correct/b.total-a.correct/a.total});for(var e,f=0;f<c.length;f++)e=$("<li class='stat-item'></li>").text(c[f].name+" - "+c[f].correct+"/"+c[f].total),e.css("background",b(100*c[f].correct/c[f].total)),this.statsList.append(e);this.statsPage.removeClass("hidden-page"),this.menuPage.addClass("hidden-page")},App.prototype.randomQuestions=function(a){var b=d3.shuffle(this.geo.countries);return b.slice(0,a)},App.prototype.startQuiz=function(a){this.questions=a,this.currentQuestion=0,this.totalCorrect=0,this.results={},this.totalQuestionsEl.text(a.length),this.quizPage.removeClass("hidden-page"),this.menuPage.addClass("hidden-page"),this.showNextQuizQuestion()},App.prototype.progressBackground=function(){var a=100*this.totalCorrect/this.questions.length,b=100*(this.currentQuestion-1)/this.questions.length;return"linear-gradient(to right, #78d376 "+a+"%, #f16a28 "+a+"%, #f16a28 "+b+"%, #81480c "+b+"%)"},App.prototype.showNextQuizQuestion=function(){if(this.currentQuestion===this.questions.length)this.saveQuizResults(),this.questions=null,this.showMainMenu();else{this.currentQuestion++;var a=this.questions[this.currentQuestion-1];this.showQuestion(a),this.currentQuestionEl.text(this.currentQuestion),this.progressIndicatorEl.css("background",this.progressBackground()),this.countryInputEl.val(""),$(".judgement-icon").removeClass("incorrect").removeClass("correct"),this.correctCountryEl.hide()}},App.prototype.showQuestion=function(a){this.correctAnswerEl.fadeOut(),this.incorrectAnswerEl.fadeOut(),this.nextQuestionEl.hide(),this.countryInputsEl.show(),this.correctAnswer=a.name,this.geo.showCountry(a)},App.prototype.checkAnswer=function(){this.countryInputEl.val().toLowerCase()===this.correctAnswer.toLowerCase()?(this.correctAnswerEl.fadeIn(),this.totalCorrect++,this.results[this.correctAnswer]=!0,$(".judgement-icon").addClass("correct")):(this.incorrectAnswerEl.fadeIn(),this.results[this.correctAnswer]=!1,$(".judgement-icon").addClass("incorrect")),this.correctCountryEl.html("<div>"+this.questions[this.currentQuestion-1].name+"</div>").show().find("div").textillate({"in":{effect:"bounceIn",delayScale:2,delay:40}}),this.countryInputsEl.hide(),this.nextQuestionEl.show()},queue().defer(d3.json,"./data/world-110m.json").defer(d3.tsv,"./data/world-country-names.tsv").await(function(a,b,c){new App(b,c)});